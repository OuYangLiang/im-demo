<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<head>
    <title>IM Demo Login</title>
    <script src="vue.js"></script>
    <script src="vue-resource.min.js"></script>
    <link rel="stylesheet" href="chat.css">
</head>

<body>

    <div class="total_box" id="app">
        <div class="contact_box">
            <div class="contact" v-bind:class="{ contact_active: contact.active }" v-for="contact of contacts">
                {{contact.userId}}
            </div>
            <!-- <div class="contact">
                Lisa
            </div>
            <div class="contact">
                Pig
            </div> -->
        </div>

        <div class="chat_box">
            <div v-for="message of currentMessages" >
                <div class="message_box_received_header" v-if="message.direction == 'received'">
                    <div class="user">
                        {{message.receiverId}}
                    </div>

                    <div class="timestamp">
                        {{message.timestamp}}
                    </div>
                </div>
                <div class="message_box_send_header" v-else>
                    <div class="user">
                        {{message.senderId}}
                    </div>

                    <div class="timestamp">
                        {{message.timestamp}}
                    </div>
                </div>

                <div class="clear_float" ></div>

                <div class="message_box_received_body" v-if="message.direction == 'received'">
                    <div class="avatar">
                        <img class="icon" src="user1-128x128.jpg" alt="message user image">
                    </div>

                    <div class="content">
                        {{message.content}}
                    </div>
                </div>
                <div class="message_box_send_body" v-else>
                    <div class="avatar">
                        <img class="icon" src="user3-128x128.jpg" alt="message user image">
                    </div>

                    <div class="content">
                        {{message.content}}
                    </div>
                </div>

                <div class="clear_float" ></div>
            </div>
        </div>

        <div class="send_box">
            <input type="text" v-model="contentInput" placeholder="Please Input" />
            <input type="button" v-on:click="send" value="发送">
        </div>
    </div>

    <script>
        function  uuid() {
            var  s = [];
            var  hexDigits =  "0123456789abcdef" ;
            for  ( var  i = 0; i < 36; i++) {
                s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
            }
            s[14] =  "4" ;   // bits 12-15 of the time_hi_and_version field to 0010
            s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);   // bits 6-7 of the clock_seq_hi_and_reserved to 01
            s[8] = s[13] = s[18] = s[23] =  "-" ;

            var  uuid = s.join( "" );
            return  uuid;
        }

        var vm = new Vue({
            el: '#app',
            data: {
                userId: '',
                sec: '',

                contentInput: null,
                contacts: [],
                currentActive: null,
                currentMessages: [],
                messages: {"oyl":[
                  {
                    "direction": ["sent"],
                    "senderId": "oyl",
                    "receiverId": "oyl",
                    "timestamp": "23 Jan 2:00 pm",
                    "content": "Working with AdminLTE on a great new app! Wanna join?",
                    "msgType": "text"
                  },
                  {
                    "direction": ["received"],
                    "senderId": "oyl",
                    "receiverId": "oyl",
                    "timestamp": "23 Jan 3:00 pm",
                    "content": "Fuck you Fuck you",
                    "msgType": "text"
                  }
                ]},
                socket: null,
                connected: false,
                intervalId: null
            },
            methods: {
                validate: function() {
                    var idx = location.href.indexOf("?");
                    if (-1 == idx) {
                        alert("非法访问");
                        return;
                    }

                    if(typeof(WebSocket) == "undefined") {
                        alert("您的浏览器不支持WebSocket");
                        return;
                    }

                    var param = decodeURIComponent(location.href.substr(idx + 1));
                    this.userId = param.split("|")[0];
                    this.sec = param.split("|")[1];

                    this.$http.post("check", { userId: this.userId, sec: this.sec}, {emulateJSON: false}).then(function(res) {
                        if (!res.body.success) {
                            alert(res.body.errMsg);
                            return;
                        }

                        this.connect();
                    }, function(res) {
                        console.log(res);
                    });
                },
                initContactList: function() {
                    this.$http.post("onlineUsers", {userId: this.userId}, {emulateJSON: false}).then(function(res) {
                        console.log(res);
                        if (!res.body.success) {
                            return;
                        }

                        res.body.data.forEach(function(item, idx) {
                            var obj = {};
                            obj.userId = item;
                            obj.active = false;
                            vm.contacts.push(obj);
                        });

                        vm.contacts[0].active = true;
                        vm.currentActive = vm.contacts[0];
                        vm.currentMessages = vm.messages[vm.currentActive.userId];

                    }, function(res) {
                        console.log(res);
                    });
                },
                send: function() {
                    var param = {};
                    param.type = "business";
                    param.subType = "text";
                    param.content = {};
                    param.content.senderId = this.userId;
                    param.content.receiverId = this.currentActive.userId;
                    param.content.content = this.contentInput;
                    param.content = JSON.stringify(param.content);
                    param.msgId = uuid();
                    this.socket.send(JSON.stringify(param));

                    param = {};
                    param.direction = "sent";
                    param.senderId = this.userId;
                    param.receivered = this.currentActive.userId;
                    param.timestamp = "xxx";
                    param.type = "text";
                    param.content = this.contentInput;

                    //this.currentMessages.push(param);
                    this.messages[vm.currentActive.userId].push(param);
                },
                connect: function() {
                    if(this.socket!=null) {
                        this.socket.close();
                        this.socket = null;
                    }

                    this.socket = new WebSocket("ws://localhost:9080/webSocket");

                    this.socket.onopen = function() {
                        var param = {};
                        param.type = "connect";
                        param.msgId = uuid();
                        param.content = vm.userId;

                        vm.socket.send(JSON.stringify(param));
                        alert("websocket已打开");
                        vm.intervalId = setInterval(function() {
                            var param = {};
                            param.type = "heartbeat";
                            param.msgId = uuid();
                            vm.socket.send(JSON.stringify(param));
                        }, 20000);

                        vm.initContactList();
                    };
                    //获得消息事件
                    this.socket.onmessage = function(msg) {
                        console.log(msg.data);
                        var data = JSON.parse(msg.data);
                        console.log(data);
                        if (data.type=="connect_ack") {
                            alert("connected");
                            vm.connected = true;
                            return;
                        }

                        if (data.type=="heartbeat_ack" || data.type=="business_ack") {
                            return;
                        }

                        alert(msg.data);
                    };

                    this.socket.onclose = function() {
                        clearInterval(vm.intervalId);
                        alert("websocket已关闭");
                    };

                    this.socket.onerror = function() {
                        alert("websocket发生了错误");
                    }
                }
            },
            created: function() {
                this.validate();
            }
        })
    </script>
</body>

</html>
